# Examples:
# Run all with MPI: make -j all MPI=1
# Run one without MPI: make -j one

#################################################################################
# GLOBALS                                                                       #
#################################################################################

RICH_PROBLEM := ShockTube

LMOD_ENV := new_rich_build			# This will be called by module restore $(LMOD_ENV)
CONDA_ENV := richanalysis
RICH_PATH := /home/hey4/RICH-fwrk
RAW_DATA_PATH := /home/hey4/rich_tde/data/raw/ShockTubeIdealGas
PRO_DATA_PATH := $(subst raw,processed,$(RAW_DATA_PATH))

MPI ?= 0

ifeq ($(MPI),1)
MPI_BUILD_SUFFIX := --mpi
else
MPI_BUILD_SUFFIX :=
endif

IS_ALL := $(filter all,$(MAKECMDGOALS))
ifneq ($(IS_ALL),all)
PL ?= 1
DL ?= 1
PR ?= 0.1
DR ?= 0.125
OUTPUT_PATH := $(RAW_DATA_PATH)/PL$(PL)PR$(PR)DL$(DL)DR$(DR)

.PHONY: one
one: $(OUTPUT_PATH)/snap_final.h5
endif

.DEFAULT_GOAL := all

.PHONY: all
all:
	$(MAKE) allics
	$(MAKE) runall

IC_DIRS = $(shell ls -d $(RAW_DATA_PATH)/PL*PR*DL*DR* 2>/dev/null)
ALL_SNAPS = $(IC_DIRS:%=%/snap_final.h5)

.SECONDARY: run_mpi.sh run_serial.sh build.sh #do not rerun the whole sim if only .sh are updated

#################################################################################
# Post-processing                                                               #
#################################################################################

.PHONY: postprocess
postprocess: $(PRO_DATA_PATH)/shocktube_tests.hdf5

# Post-processing
# The "" in the third line is necessary, otherwise * is
# expanded before python sees it, which forbid us from 
# doing glob.glob()
$(PRO_DATA_PATH)/shocktube_tests.hdf5: pp.py
	mkdir -p $(@D)
	source ~/.bashrc && conda activate $(CONDA_ENV) && \
	python pp.py "$(RAW_DATA_PATH)/*" $@ -f


#################################################################################
# Running simulation                                                            #
#################################################################################

## Single run, only defined if not make all
ifneq ($(IS_ALL),all)
ifeq ($(MPI),1)
$(OUTPUT_PATH)/snap_final.h5: $(OUTPUT_PATH)/leftpressure.txt \
  $(OUTPUT_PATH)/leftdensity.txt $(OUTPUT_PATH)/rightpressure.txt \
  $(OUTPUT_PATH)/rightdensity.txt | run_mpi.sh $(RICH_PATH)/build/rich 
	mkdir -p $(@D) && cd $(@D) && sbatch $(CURDIR)/run_mpi.sh
else
$(OUTPUT_PATH)/snap_final.h5: $(OUTPUT_PATH)/leftpressure.txt \
  $(OUTPUT_PATH)/leftdensity.txt $(OUTPUT_PATH)/rightpressure.txt \
  $(OUTPUT_PATH)/rightdensity.txt | run_serial.sh $(RICH_PATH)/build/rich 
	mkdir -p $(@D) && cd $(@D) && $(CURDIR)/run_serial.sh
endif
endif

## Run all ICs generated by ics.py
.PHONY: runall
runall: $(ALL_SNAPS)
ifeq ($(MPI),1)
$(RAW_DATA_PATH)/%/snap_final.h5: $(RAW_DATA_PATH)/%/leftpressure.txt \
  $(RAW_DATA_PATH)/%/leftdensity.txt $(RAW_DATA_PATH)/%/rightpressure.txt \
  $(RAW_DATA_PATH)/%/rightdensity.txt $(RICH_PATH)/build/rich | run_mpi.sh 
	cd $(@D) && sbatch $(CURDIR)/run_mpi.sh
else
$(RAW_DATA_PATH)/%/snap_final.h5: $(RAW_DATA_PATH)/%/leftpressure.txt \
  $(RAW_DATA_PATH)/%/leftdensity.txt $(RAW_DATA_PATH)/%/rightpressure.txt \
  $(RAW_DATA_PATH)/%/rightdensity.txt $(RICH_PATH)/build/rich | run_serial.sh 
	cd $(@D) && $(CURDIR)/run_serial.sh
endif

$(RICH_PATH)/build/rich: $(RICH_PATH)/runs/ShockTube/main.cpp
	printf '%s\n' \
		'#!/bin/bash -l' \
		'rm -r $(RICH_PATH)/build' \
		'module purge && module restore $(LMOD_ENV)' \
		'$(RICH_PATH)/config.py --problem=$(RICH_PROBLEM) $(MPI_BUILD_SUFFIX)' \
		'$(MAKE) -C $(RICH_PATH)' \
	> ./build.sh
	chmod +x ./build.sh

	./build.sh

ifeq ($(MPI),1)
run_mpi.sh:
	printf '%s\n' \
		'#!/bin/bash -l' \
		'#SBATCH --partition=gpu_strw' \
		'#SBATCH --account=gpu_strw' \
		'#SBATCH --job-name=shocktubes' \
		'#SBATCH --time=0-01:00:00 # max 7 days' \
		'#SBATCH --output=/home/hey4/RICH/jobs/logs/%j_%x.out   # %x: Job name, %j: Job id' \
		'#SBATCH --nodes=1' \
		'#SBATCH --ntasks=12	# max 48 per node for gpu_strw' \
		'#SBATCH --cpus-per-task=1' \
		'#SBATCH --mem=8G	    # max 61G per node for gpu_strw' \
		'#SBATCH --mail-user="yujiehe@strw.leidenuniv.nl"' \
		'#SBATCH --mail-type="ALL"' \
		'echo "Date: $$(date)"' \
		'echo "Batch script:"' \
		'cat "$$0"' \
		'echo "==============================================="' \
		'module purge && module restore $(LMOD_ENV)' \
		'sleep $$(shuf -i 0-20 -n 1) # pause a random time between 0-20 seconds to avoid the hdf5 writing error' \
		'srun $(RICH_PATH)/build/rich' \
	> $@
else
run_serial.sh:
	printf '%s\n' \
		'#!/bin/bash -l' \
		'module purge && module restore $(LMOD_ENV)' \
		'$(RICH_PATH)/build/rich' \
	> $@
	chmod +x $@
endif

.PHONY: allics
allics:
	source ~/.bashrc && conda activate $(CONDA_ENV) && python ics.py $(RAW_DATA_PATH) -n 20

.PHONY: clean
clean:
	rm -r __pycache__ .mpi_stamp_* build.sh run_mpi.sh run_serial.sh

$(OUTPUT_PATH)/leftpressure.txt:
	mkdir -p $(@D) && echo $(PL) > $@

$(OUTPUT_PATH)/leftdensity.txt:
	mkdir -p $(@D) && echo $(DL) > $@

$(OUTPUT_PATH)/rightpressure.txt:
	mkdir -p $(@D) && echo $(PR) > $@

$(OUTPUT_PATH)/rightdensity.txt:
	mkdir -p $(@D) && echo $(DR) > $@